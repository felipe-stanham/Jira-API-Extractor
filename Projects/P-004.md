# P-004: Add JQL Filter and Fix Story Points

## Project Overview

**Goal**: Fix story points extraction to support multiple fields and add JQL filtering capability for better issue filtering.

**Timeline**: 2-3 days

**Status**: ðŸ“‹ Planning

**Reference**: See `InputDocs/Project-004.md` for detailed requirements.

---

## Requirements Summary

### Problem 1: Story Points Field Inconsistency
Jira has two fields for story points:
- "Story Points" (customfield varies by instance)
- "Story Points Estimate" (customfield varies by instance)

Current implementation only checks one field, but different projects use different fields.

### Problem 2: No JQL Filtering Support
Projects use separate boards to organize sub-projects/threads, but there's no way to filter issues beyond sprint/epic/label.

### Solution 1: Dual Story Points Field Support
**Logic**:
1. Check both "Story Points" and "Story Points Estimate" fields
2. If both are null â†’ use 0
3. If one is not null â†’ use that value
4. If both are not null â†’ use "Story Points" field (priority)

### Solution 2: JQL Filter Parameter
**Scope**:
- âœ… Applies to: Sprint issues, Open epic issues
- âŒ Does NOT apply to: Comments sheet, Worklogs sheet

**Implementation**: Add optional JQL parameter that gets appended to existing queries

---

## Scope 1: Story Points Field Enhancement

**Objective**: Support both Story Points fields with proper fallback logic.

### Tasks

- [ ] Research both story points custom field IDs in Jira
- [ ] Update config.py to support two story points fields
- [ ] Create helper function to extract story points with fallback logic
- [ ] Update all locations that read story points:
  - [ ] Sprint issues extraction
  - [ ] Epic label issues extraction
  - [ ] Open epic issues extraction
  - [ ] Progress data aggregation
- [ ] Test with projects using different story points fields

---

## Scope 2: JQL Filter Implementation

**Objective**: Add JQL filtering capability to sprint and epic queries.

### Tasks

- [ ] Add JQL parameter to command line arguments (main.py)
- [ ] Add JQL input field to Streamlit UI
- [ ] Update get_issues_in_sprint() to accept and apply JQL filter
- [ ] Update get_epic_issues() to accept and apply JQL filter
- [ ] Update get_open_epic_issues() to accept and apply JQL filter
- [ ] Ensure JQL is properly combined with existing queries (AND logic)
- [ ] Test JQL filtering with various queries
- [ ] Validate JQL does NOT affect comments/worklogs extraction

---

## Scope 3: Testing & Documentation

**Objective**: Comprehensive testing and documentation updates.

### Tasks

- [ ] Test story points extraction with both fields
- [ ] Test story points fallback logic (null, one value, both values)
- [ ] Test JQL filtering with sprint issues
- [ ] Test JQL filtering with epic issues
- [ ] Test that JQL does NOT filter comments/worklogs
- [ ] Update README.md with JQL parameter documentation
- [ ] Update docs/architecture.md if needed
- [ ] Add lessons learned to Lessons.md
- [ ] Update P-004.md with completion status

---

## Technical Approach

### Story Points Field Strategy

**Current Implementation**:
```python
story_points = issue['fields'].get(JIRA_STORY_POINTS_FIELD, 0)
```

**New Implementation**:
```python
def get_story_points(issue_fields):
    """
    Extract story points with fallback logic.
    Priority: Story Points > Story Points Estimate > 0
    """
    sp_field = issue_fields.get(JIRA_STORY_POINTS_FIELD)
    sp_estimate_field = issue_fields.get(JIRA_STORY_POINTS_ESTIMATE_FIELD)
    
    # Both null
    if sp_field is None and sp_estimate_field is None:
        return 0
    
    # Both not null - use Story Points
    if sp_field is not None and sp_estimate_field is not None:
        return float(sp_field) if sp_field else 0
    
    # One is not null - use that one
    return float(sp_field or sp_estimate_field)
```

### JQL Filter Strategy

**Implementation Approach**:
1. Add optional `jql` parameter to API methods
2. Combine user JQL with existing query using AND
3. Example: `sprint = 593 AND (user_jql_here)`

**Files to Modify**:
- `main.py`: Add --jql argument
- `jira_api.py`: Update methods to accept and apply JQL
- `config.py`: Add JIRA_STORY_POINTS_ESTIMATE_FIELD

**JQL Combination Logic**:
```python
if jql:
    base_jql = f"sprint = {sprint_id}"
    combined_jql = f"{base_jql} AND ({jql})"
else:
    combined_jql = f"sprint = {sprint_id}"
```

---

## Success Criteria

### Story Points
âœ… Extracts from "Story Points" field when available
âœ… Falls back to "Story Points Estimate" when "Story Points" is null
âœ… Returns 0 when both fields are null
âœ… Prioritizes "Story Points" when both fields have values
âœ… Works across all sheets (Sprint, Epic Label, Open Epics, Progress)

### JQL Filter
âœ… JQL parameter available in command line
âœ… JQL parameter available in Streamlit UI
âœ… JQL correctly filters sprint issues
âœ… JQL correctly filters epic issues
âœ… JQL does NOT filter comments
âœ… JQL does NOT filter worklogs
âœ… JQL properly combines with existing queries (AND logic)
âœ… Empty/null JQL works (no filtering applied)

### Documentation
âœ… README updated with JQL usage examples
âœ… Architecture documentation updated if needed
âœ… Lessons learned captured
âœ… All tests passing

---

## Design Decisions

### Question 1: Story Points Field Configuration
**Decision**: Add second field to config.py as `JIRA_STORY_POINTS_ESTIMATE_FIELD`
**Rationale**: Different Jira instances use different custom field IDs, need configurability

### Question 2: JQL Validation
**Decision**: No JQL validation in our code - let Jira API handle it
**Rationale**: Jira API will return proper error messages for invalid JQL

### Question 3: JQL Parameter Format
**Decision**: Accept raw JQL string, wrap in parentheses when combining
**Rationale**: Maximum flexibility for users, proper precedence with AND operator

### Question 4: Default Story Points Estimate Field
**Decision**: Use common default (customfield_10026) but make it configurable
**Rationale**: Provide sensible default while allowing customization

---

## Risks & Mitigations

**Risk 1**: Different Jira instances use different custom field IDs
- **Mitigation**: Make both fields configurable in JiraExtractor.env

**Risk 2**: Invalid JQL could break queries
- **Mitigation**: Let Jira API handle validation, show clear error messages to user

**Risk 3**: JQL might accidentally filter out expected results
- **Mitigation**: Clear documentation and examples, optional parameter (empty = no filter)

---

## Next Steps

1. Research story points custom field IDs
2. Implement Scope 1 (Story Points Enhancement)
3. Implement Scope 2 (JQL Filter)
4. Complete Scope 3 (Testing & Documentation)

**Ready for implementation!** ðŸš€
